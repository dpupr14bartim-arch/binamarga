<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Informasi Jembatan ‚Äî PUPR Barito Timur</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body{margin:0;background:#0a1a2a;color:#eaf4ff;font-family:Segoe UI}
header{padding:18px;text-align:center;background:#0b3c5d;border-bottom:3px solid #f4b400}
header h1{margin:0;font-size:1.6rem}
header small{color:#ffe08a}

#map{height:65vh}

.panel{
 position:absolute;top:90px;right:20px;width:340px;
 background:#0e253a;border-radius:14px;padding:14px;
 box-shadow:0 0 25px rgba(0,0,0,.7);z-index:999
}

input,select,button{
 width:100%;margin-top:6px;padding:10px;
 border-radius:8px;border:none
}
button{background:#f4b400;font-weight:bold}

.hidden{display:none}
img{width:100%;border-radius:10px;border:2px solid #f4b400}
</style>
</head>

<body>

<header>
<h1>Sistem Informasi Jembatan</h1>
<small>Dinas PUPR Kabupaten Barito Timur</small>
</header>

<select id="filterKec" style="margin:10px">
<option value="ALL">SEMUA KECAMATAN</option>
<option>Dusun Timur</option>
<option>Awang</option>
<option>Dusun Tengah</option>
<option>Patangkep Tutui</option>
<option>Pematang Karau</option>
<option>Paju Epat</option>
<option>Raren Batuah</option>
<option>Paku</option>
<option>Karusen Janang</option>
<option>Benua Lima</option>
</select>

<div id="map"></div>

<!-- PANEL VIEW / EDIT -->
<div class="panel hidden" id="panel">
<img id="foto">
<input id="no_jembatan" placeholder="No Jembatan">
<input id="nama_jembatan" placeholder="Nama Jembatan">
<input id="ruas_jalan" placeholder="Ruas Jalan">
<input id="desa" placeholder="Desa / Kelurahan">
<select id="kecamatan">
<option>Dusun Timur</option><option>Awang</option>
<option>Dusun Tengah</option><option>Patangkep Tutui</option>
<option>Pematang Karau</option><option>Paju Epat</option>
<option>Raren Batuah</option><option>Paku</option>
<option>Karusen Janang</option><option>Benua Lima</option>
</select>
<input id="lat" placeholder="Latitude">
<input id="lng" placeholder="Longitude">
<select id="kondisi"><option>Baik</option><option>Rusak</option></select>
<input type="file" id="fotoFile" accept="image/*" capture>
<button onclick="ambilGPS()">üìç Ambil Lokasi</button>
<button onclick="simpan()">üíæ Simpan</button>
</div>

<button onclick="tambahBaru()" style="
 position:fixed;bottom:25px;right:25px;
 background:#f4b400;border:none;border-radius:50%;
 width:60px;height:60px;font-size:26px">Ôºã</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API="PASTE_URL_GAS_EXEC_DI_SINI";

const map=L.map("map").setView([-2.1,115.2],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const layer=L.layerGroup().addTo(map);

const icon=L.icon({iconUrl:"pupr.png",iconSize:[38,38],iconAnchor:[19,38]});

let currentRow=null,fotoLama="";

filterKec.onchange=load;
load();

async function load(){
 layer.clearLayers();
 panel.classList.add("hidden");
 const r=await fetch(API+"?kecamatan="+filterKec.value);
 const j=await r.json();

 j.data.forEach(d=>{
  if(isNaN(d.lat))return;
  const m=L.marker([d.lat,d.lng],{icon}).addTo(layer);
  m.on("click",()=>edit(d));
 });
}

function edit(d){
 panel.classList.remove("hidden");
 currentRow=d.rowIndex;
 fotoLama=d.foto||"";
 foto.src=d.foto||"https://via.placeholder.com/300x180";
 no_jembatan.value=d.no_jembatan;
 nama_jembatan.value=d.nama_jembatan;
 ruas_jalan.value=d.ruas_jalan;
 desa.value=d.desa_kelurahan;
 kecamatan.value=d.kecamatan;
 lat.value=d.lat;
 lng.value=d.lng;
 kondisi.value=d.kondisi;
}

function tambahBaru(){
 currentRow=null;fotoLama="";
 panel.classList.remove("hidden");
 document.querySelectorAll("#panel input").forEach(i=>i.value="");
 foto.src="https://via.placeholder.com/300x180";
}

map.on("click",e=>{
 lat.value=e.latlng.lat.toFixed(6);
 lng.value=e.latlng.lng.toFixed(6);
});

function ambilGPS(){
 navigator.geolocation.getCurrentPosition(p=>{
  lat.value=p.coords.latitude.toFixed(6);
  lng.value=p.coords.longitude.toFixed(6);
 });
}

async function simpan(){
 let base64="";
 const f=fotoFile.files[0];
 if(f){
  base64=await new Promise(r=>{
   const fr=new FileReader();
   fr.onload=()=>r(fr.result);
   fr.readAsDataURL(f);
  });
 }
 await fetch(API,{
  method:"POST",
  body:JSON.stringify({
   rowIndex:currentRow,
   no_jembatan:no_jembatan.value,
   nama_jembatan:nama_jembatan.value,
   ruas_jalan:ruas_jalan.value,
   kecamatan:kecamatan.value,
   desa_kelurahan:desa.value,
   lat:lat.value,lng:lng.value,
   kondisi:kondisi.value,
   fotoBase64:base64,
   foto_lama:fotoLama
  })
 });
 alert("‚úî Tersimpan");
 panel.classList.add("hidden");
 load();
}
</script>

</body>
</html>
