<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Informasi Jembatan ‚Äì PUPR Barito Timur</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
/* ===================== GLOBAL ===================== */
body{
  margin:0;
  font-family:Segoe UI, sans-serif;
  background:#020216;
  color:#e0f7ff;
}

/* ===================== HEADER ===================== */
header{
  background:#000814;
  border-bottom:3px solid #f4b400;
}
.header-inner{
  max-width:1200px;
  margin:auto;
  padding:14px 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
header img{
  height:56px;
}
header .title{
  text-align:center;
}
header h1{
  margin:0;
  font-size:1.5rem;
}
header small{
  color:#ffe08a;
}

/* ===================== FILTER ===================== */
.filter{
  max-width:1200px;
  margin:12px auto;
  padding:0 15px;
}
select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#071427;
  color:#e0f7ff;
  font-size:15px;
}

/* ===================== MAP ===================== */
#map{
  height:65vh;
  margin:0 15px;
  border-radius:12px;
  box-shadow:0 0 20px rgba(0,0,0,.6);
}

/* ===================== PANEL DETAIL ===================== */
#panel{
  position:absolute;
  top:110px;
  right:25px;
  width:340px;
  background:#071427;
  padding:14px;
  border-radius:14px;
  box-shadow:0 0 25px rgba(0,0,0,.8);
  display:none;
  z-index:999;
}
#panel img{
  width:100%;
  border-radius:10px;
  border:2px solid #f4b400;
  margin-bottom:8px;
}
label{
  font-size:12px;
  color:#9ecbff;
}
input,select,button{
  width:100%;
  margin-top:6px;
  padding:9px;
  border-radius:8px;
  border:none;
}
button{
  background:#f4b400;
  font-weight:bold;
  cursor:pointer;
}
.actions{
  display:flex;
  gap:6px;
}

/* ===================== ADD BUTTON ===================== */
#btnAdd{
  position:fixed;
  bottom:25px;
  right:25px;
  width:60px;
  height:60px;
  border-radius:50%;
  border:none;
  background:#f4b400;
  font-size:28px;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <div class="header-inner">
    <img src="bartim.png">
    <div class="title">
      <h1>Sistem Informasi Jembatan</h1>
      <small>Dinas PUPR Kabupaten Barito Timur</small>
    </div>
    <img src="logopupr.png">
  </div>
</header>

<div class="filter">
  <select id="filterKec">
    <option value="">‚Äî Pilih Kecamatan ‚Äî</option>
    <option>Dusun Timur</option>
    <option>Awang</option>
    <option>Dusun Tengah</option>
    <option>Patangkep Tutui</option>
    <option>Pematang Karau</option>
    <option>Paju Epat</option>
    <option>Raren Batuah</option>
    <option>Paku</option>
    <option>Karusen Janang</option>
    <option>Benua Lima</option>
  </select>
</div>

<div id="map"></div>

<!-- PANEL DETAIL / EDIT -->
<div id="panel">
  <img id="foto">
  <label>No Jembatan</label><input id="no_jembatan">
  <label>Nama Jembatan</label><input id="nama_jembatan">
  <label>Jenis Konstruksi</label><input id="jenis_konstruksi">
  <label>Ruas Jalan</label><input id="ruas_jalan">
  <label>Kecamatan</label>
  <select id="kecamatan">
    <option>Dusun Timur</option><option>Awang</option>
    <option>Dusun Tengah</option><option>Patangkep Tutui</option>
    <option>Pematang Karau</option><option>Paju Epat</option>
    <option>Raren Batuah</option><option>Paku</option>
    <option>Karusen Janang</option><option>Benua Lima</option>
  </select>
  <label>Desa / Kelurahan</label><input id="desa">
  <label>Latitude</label><input id="lat">
  <label>Longitude</label><input id="lng">
  <label>Panjang (m)</label><input id="panjang">
  <label>Lebar (m)</label><input id="lebar">
  <label>Jumlah Bentang</label><input id="jumlah_bentang">
  <label>Kondisi</label><input id="kondisi">
  <input type="file" id="fotoFile" accept="image/*">
  <div class="actions">
    <button onclick="ambilGPS()">üìç GPS</button>
    <button onclick="simpan()">üíæ Simpan</button>
  </div>
</div>

<button id="btnAdd" onclick="tambah()">Ôºã</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ================= KONFIG ================= */
const API_URL = "PASTE_URL_GAS_EXEC_DI_SINI";

/* ================= MAP ================= */
const map = L.map("map").setView([-2.1,115.2],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const layer = L.layerGroup().addTo(map);

const icon = L.icon({
  iconUrl:"pupr.png",
  iconSize:[36,36],
  iconAnchor:[18,36]
});

/* ================= STATE ================= */
let currentRow = null;
let fotoLama = "";

/* ================= LOAD ================= */
filterKec.onchange = loadData;

async function loadData(){
  layer.clearLayers();
  panel.style.display="none";
  if(!filterKec.value) return;

  const res = await fetch(API_URL+"?kecamatan="+encodeURIComponent(filterKec.value));
  const j = await res.json();

  j.data.forEach(d=>{
    if(isNaN(d.lat)||isNaN(d.lng)) return;
    const m = L.marker([d.lat,d.lng],{icon}).addTo(layer);
    m.on("click",()=>edit(d));
  });
}

/* ================= EDIT ================= */
function edit(d){
  panel.style.display="block";
  currentRow = d.rowIndex;
  fotoLama = d.foto || "";
  foto.src = d.foto || "https://via.placeholder.com/300x180";
  no_jembatan.value=d.no_jembatan||"";
  nama_jembatan.value=d.nama_jembatan||"";
  jenis_konstruksi.value=d.jenis_konstruksi||"";
  ruas_jalan.value=d.ruas_jalan||"";
  kecamatan.value=d.kecamatan||"";
  desa.value=d.desa_kelurahan||"";
  lat.value=d.lat||"";
  lng.value=d.lng||"";
  panjang.value=d.panjang||"";
  lebar.value=d.lebar||"";
  jumlah_bentang.value=d.jumlah_bentang||"";
  kondisi.value=d.kondisi||"";
}

/* ================= ADD ================= */
function tambah(){
  panel.style.display="block";
  currentRow=null; fotoLama="";
  document.querySelectorAll("#panel input").forEach(i=>i.value="");
  foto.src="https://via.placeholder.com/300x180";
}

/* ================= GPS ================= */
function ambilGPS(){
  navigator.geolocation.getCurrentPosition(p=>{
    lat.value=p.coords.latitude.toFixed(6);
    lng.value=p.coords.longitude.toFixed(6);
  });
}

/* ================= SAVE ================= */
async function simpan(){
  let base64="";
  if(fotoFile.files[0]){
    const fr=new FileReader();
    base64=await new Promise(r=>{
      fr.onload=()=>r(fr.result);
      fr.readAsDataURL(fotoFile.files[0]);
    });
  }

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      rowIndex:currentRow,
      no_jembatan:no_jembatan.value,
      nama_jembatan:nama_jembatan.value,
      jenis_konstruksi:jenis_konstruksi.value,
      ruas_jalan:ruas_jalan.value,
      kecamatan:kecamatan.value,
      desa_kelurahan:desa.value,
      lat:lat.value,
      lng:lng.value,
      panjang:panjang.value,
      lebar:lebar.value,
      jumlah_bentang:jumlah_bentang.value,
      kondisi:kondisi.value,
      fotoBase64:base64,
      foto_lama:fotoLama
    })
  });
  alert("‚úî Data tersimpan");
  panel.style.display="none";
  loadData();
}
</script>

</body>
</html>
