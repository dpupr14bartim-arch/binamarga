<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Informasi Jembatan ‚Äî PUPR Barito Timur</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
/* ================= DASAR ================= */
body{
  margin:0;
  background:#020216;
  color:#e0f7ff;
  font-family:Segoe UI, sans-serif;
}
header{
  padding:18px;
  text-align:center;
  background:#0b3c5d;
  border-bottom:3px solid #f4b400;
}
header h2{
  margin:0;
  font-size:1.5rem;
  letter-spacing:.5px;
}
.container{
  padding:12px;
  max-width:1100px;
  margin:auto;
}

/* ================= FILTER ================= */
select, input, button{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:none;
  background:#071a33;
  color:#e0f7ff;
}
button{
  background:#f4b400;
  color:#001;
  font-weight:bold;
  cursor:pointer;
}

/* ================= MAP ================= */
#map{
  height:420px;
  margin-top:12px;
  border-radius:12px;
}

/* ================= PANEL FORM ================= */
.panel{
  position:fixed;
  top:90px;
  right:20px;
  width:340px;
  max-height:80vh;
  overflow:auto;
  background:#071427;
  padding:12px;
  border-radius:14px;
  box-shadow:0 0 25px rgba(0,0,0,.7);
  z-index:999;
}
.hidden{display:none}

.panel img{
  width:100%;
  border-radius:10px;
  border:2px solid #f4b400;
  margin-bottom:6px;
}

/* ================= FLOAT BUTTON ================= */
.fab{
  position:fixed;
  bottom:22px;
  right:22px;
  width:60px;
  height:60px;
  border-radius:50%;
  font-size:26px;
  border:none;
  background:#f4b400;
  color:#000;
}
</style>
</head>

<body>

<header>
  <h2>üõ£Ô∏è Sistem Informasi Jembatan ‚Äî PUPR Barito Timur</h2>
</header>

<div class="container">

  <select id="filterKec">
    <option value="">‚Äî Pilih Kecamatan ‚Äî</option>
    <option>Dusun Timur</option>
    <option>Awang</option>
    <option>Dusun Tengah</option>
    <option>Patangkep Tutui</option>
    <option>Pematang Karau</option>
    <option>Paju Epat</option>
    <option>Raren Batuah</option>
    <option>Paku</option>
    <option>Karusen Janang</option>
    <option>Benua Lima</option>
  </select>

  <div id="map"></div>

</div>

<!-- PANEL DETAIL -->
<div class="panel hidden" id="panel">

  <input type="hidden" id="rowIndex">

  <img id="fotoPreview" src="https://via.placeholder.com/300x180">

  <input id="no_jembatan" placeholder="Nomor Jembatan">
  <input id="nama_jembatan" placeholder="Nama Jembatan">
  <input id="jenis_konstruksi" placeholder="Jenis Konstruksi">
  <input id="ruas_jalan" placeholder="Ruas Jalan">
  <input id="desa_kelurahan" placeholder="Desa / Kelurahan">

  <select id="kecamatan">
    <option>Dusun Timur</option>
    <option>Awang</option>
    <option>Dusun Tengah</option>
    <option>Patangkep Tutui</option>
    <option>Pematang Karau</option>
    <option>Paju Epat</option>
    <option>Raren Batuah</option>
    <option>Paku</option>
    <option>Karusen Janang</option>
    <option>Benua Lima</option>
  </select>

  <input id="lat" placeholder="Latitude">
  <input id="lng" placeholder="Longitude">
  <button onclick="ambilGPS()">üìç Ambil Lokasi</button>

  <input id="panjang" placeholder="Panjang (m)">
  <input id="lebar" placeholder="Lebar (m)">
  <input id="jumlah_bentang" placeholder="Jumlah Bentang">

  <input id="tipe_bangunan_atas" placeholder="Tipe Bangunan Atas">
  <input id="tipe_bangunan_bawah" placeholder="Tipe Bangunan Bawah">
  <input id="tipe_pondasi" placeholder="Tipe Pondasi">
  <input id="tipe_lantai" placeholder="Tipe Lantai">

  <input id="kondisi" placeholder="Kondisi">

  <input type="file" id="fotoFile" accept="image/*" capture>

  <button onclick="simpan()">üíæ Simpan</button>
</div>

<button class="fab" onclick="tambahBaru()">Ôºã</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ================= KONFIG ================= */
const API_URL = "PASTE_URL_GAS_EXEC_DI_SINI";

/* ================= MAP ================= */
const map = L.map("map").setView([-2.13,115.10],10);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const layer = L.layerGroup().addTo(map);

const icon = L.icon({
  iconUrl:"pupr.png",
  iconSize:[36,36],
  iconAnchor:[18,36]
});

/* ================= LOAD DATA ================= */
filterKec.onchange = loadData;

async function loadData(){
  const kec = filterKec.value;
  if(!kec) return;          // ‚¨ÖÔ∏è INI KUNCI RINGAN

  layer.clearLayers();
  panel.classList.add("hidden");

  const r = await fetch(API_URL + "?kecamatan=" + encodeURIComponent(kec));
  const j = await r.json();
  if(j.status!=="success") return alert(j.message);

  j.data.forEach(d=>{
    if(isNaN(d.lat)||isNaN(d.lng)) return;
    const m = L.marker([d.lat,d.lng],{icon}).addTo(layer);
    m.on("click",()=>edit(d));
  });
}

/* ================= EDIT ================= */
function edit(d){
  panel.classList.remove("hidden");

  rowIndex.value = d.rowIndex || "";
  fotoPreview.src = d.foto || "https://via.placeholder.com/300x180";

  no_jembatan.value = d.no_jembatan || "";
  nama_jembatan.value = d.nama_jembatan || "";
  jenis_konstruksi.value = d.jenis_konstruksi || "";
  ruas_jalan.value = d.ruas_jalan || "";
  desa_kelurahan.value = d.desa_kelurahan || "";
  kecamatan.value = d.kecamatan || "";
  lat.value = d.lat || "";
  lng.value = d.lng || "";
  panjang.value = d.panjang || "";
  lebar.value = d.lebar || "";
  jumlah_bentang.value = d.jumlah_bentang || "";
  tipe_bangunan_atas.value = d.tipe_bangunan_atas || "";
  tipe_bangunan_bawah.value = d.tipe_bangunan_bawah || "";
  tipe_pondasi.value = d.tipe_pondasi || "";
  tipe_lantai.value = d.tipe_lantai || "";
  kondisi.value = d.kondisi || "";
}

/* ================= TAMBAH ================= */
function tambahBaru(){
  panel.classList.remove("hidden");
  document.querySelectorAll("#panel input").forEach(i=>i.value="");
  rowIndex.value="";
  fotoPreview.src="https://via.placeholder.com/300x180";
}

/* ================= GPS ================= */
function ambilGPS(){
  navigator.geolocation.getCurrentPosition(p=>{
    lat.value=p.coords.latitude.toFixed(6);
    lng.value=p.coords.longitude.toFixed(6);
  });
}

/* ================= SIMPAN ================= */
async function simpan(){
  let fotoBase64="";
  if(fotoFile.files[0]){
    fotoBase64=await new Promise(r=>{
      const fr=new FileReader();
      fr.onload=()=>r(fr.result);
      fr.readAsDataURL(fotoFile.files[0]);
    });
  }

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      rowIndex:rowIndex.value,
      no_jembatan:no_jembatan.value,
      nama_jembatan:nama_jembatan.value,
      jenis_konstruksi:jenis_konstruksi.value,
      ruas_jalan:ruas_jalan.value,
      kecamatan:kecamatan.value,
      desa_kelurahan:desa_kelurahan.value,
      lat:lat.value,
      lng:lng.value,
      panjang:panjang.value,
      lebar:lebar.value,
      jumlah_bentang:jumlah_bentang.value,
      tipe_bangunan_atas:tipe_bangunan_atas.value,
      tipe_bangunan_bawah:tipe_bangunan_bawah.value,
      tipe_pondasi:tipe_pondasi.value,
      tipe_lantai:tipe_lantai.value,
      kondisi:kondisi.value,
      fotoBase64
    })
  });

  alert("‚úî Data tersimpan");
  panel.classList.add("hidden");
  loadData();
}
</script>

</body>
</html>
