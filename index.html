<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Informasi Jembatan ‚Äî PUPR Barito Timur</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body{margin:0;background:#0a1a2a;color:#eaf4ff;font-family:Segoe UI}

/* ===== HEADER ===== */
.header-pupr{
  background: linear-gradient(180deg,#0b3c5d,#082c45);
  box-shadow:0 6px 30px rgba(0,0,0,.6);
}
.header-inner{
  max-width:1200px;margin:auto;
  padding:18px 24px 10px;
  display:flex;align-items:center;gap:15px
}
.logo{height:64px;filter:drop-shadow(0 0 10px rgba(244,180,0,.35))}
.judul{text-align:center;flex:1}
.judul-utama{font-size:1.75rem;font-weight:700}
.judul-sub{font-size:.95rem;color:#ffe08a}
.wave{width:100%;height:60px}

/* ===== MAP ===== */
#map{height:65vh}

/* ===== PANEL ===== */
.panel{
 position:absolute;top:100px;right:20px;width:360px;
 background:#0e253a;border-radius:14px;padding:14px;
 box-shadow:0 0 25px rgba(0,0,0,.7);z-index:999;
 max-height:80vh;overflow:auto
}

.panel h3{
 margin:4px 0 10px;color:#ffe08a
}

label{
 font-size:12px;color:#9ecbff;
 margin-top:8px;display:block
}

input,select,button{
 width:100%;margin-top:4px;padding:9px;
 border-radius:8px;border:none
}

button{
 background:#f4b400;font-weight:bold;cursor:pointer
}

.hidden{display:none}
img{width:100%;border-radius:10px;border:2px solid #f4b400}
hr{border:0;border-top:1px solid #234;margin:10px 0}
</style>
</head>

<body>

<header class="header-pupr">
  <div class="header-inner">
    <img src="bartim.png" class="logo">
    <div class="judul">
      <div class="judul-utama">Sistem Informasi Jembatan</div>
      <div class="judul-sub">Dinas PUPR Kabupaten Barito Timur</div>
    </div>
    <img src="logopupr.png" class="logo">
  </div>
  <svg class="wave" viewBox="0 0 1440 90" preserveAspectRatio="none">
    <path d="M0,40 C120,70 240,10 360,20 480,30 600,70 720,55 840,40 960,5 1080,15 1200,25 1320,45 1440,30 L1440,0 L0,0 Z"
          fill="#0a1a2a"></path>
  </svg>
</header>

<select id="filterKec" style="margin:10px">
<option value="ALL">SEMUA KECAMATAN</option>
<option>Dusun Timur</option><option>Awang</option>
<option>Dusun Tengah</option><option>Patangkep Tutui</option>
<option>Pematang Karau</option><option>Paju Epat</option>
<option>Raren Batuah</option><option>Paku</option>
<option>Karusen Janang</option><option>Benua Lima</option>
</select>

<div id="map"></div>

<!-- ===== PANEL FORM ===== -->
<div class="panel hidden" id="panel">
<h3>üìã Data Jembatan</h3>

<img id="foto">

<label>Nomor Jembatan</label>
<input id="no_jembatan">

<label>Nama Jembatan</label>
<input id="nama_jembatan">

<label>Ruas Jalan</label>
<input id="ruas_jalan">

<label>Desa / Kelurahan</label>
<input id="desa">

<label>Kecamatan</label>
<select id="kecamatan">
<option>Dusun Timur</option><option>Awang</option>
<option>Dusun Tengah</option><option>Patangkep Tutui</option>
<option>Pematang Karau</option><option>Paju Epat</option>
<option>Raren Batuah</option><option>Paku</option>
<option>Karusen Janang</option><option>Benua Lima</option>
</select>

<hr>

<label>Latitude</label>
<input id="lat">

<label>Longitude</label>
<input id="lng">

<button onclick="ambilGPS()">üìç Ambil Lokasi</button>

<hr>

<label>Panjang (meter)</label>
<input id="panjang" type="number" step="0.1">

<label>Lebar (meter)</label>
<input id="lebar" type="number" step="0.1">

<label>Jumlah Bentang</label>
<input id="bentang" type="number">

<hr>

<label>Jenis Konstruksi</label>
<select id="jenis">
<option>Beton</option><option>Kayu</option>
<option>Baja</option><option>Gantung</option>
</select>

<label>Kondisi</label>
<select id="kondisi">
<option>Baik</option>
<option>Sedang</option>
<option>Rusak</option>
<option>Rusak Berat</option>
</select>

<hr>

<label>Foto Jembatan</label>
<input type="file" id="fotoFile" accept="image/*" capture>

<button onclick="simpan()">üíæ Simpan</button>
</div>

<button onclick="tambahBaru()" style="
 position:fixed;bottom:25px;right:25px;
 background:#f4b400;border:none;border-radius:50%;
 width:60px;height:60px;font-size:26px">Ôºã</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API="https://script.google.com/macros/s/AKfycbyyAaZcRtIsm7Zh0dVBBqdM-sMInBcHo_5_RiqbGrTKyw_CUyFTemHHJJ0iK6qMm9slgQ/exec";

const map=L.map("map").setView([-2.1,115.2],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const layer=L.layerGroup().addTo(map);

const icon=L.icon({iconUrl:"pupr.png",iconSize:[38,38],iconAnchor:[19,38]});

let currentRow=null,fotoLama="";

filterKec.onchange=load;
load();

async function load(){
 layer.clearLayers();
 panel.classList.add("hidden");
 const r=await fetch(API+"?kecamatan="+filterKec.value);
 const j=await r.json();

 j.data.forEach(d=>{
  if(isNaN(d.lat))return;
  const m=L.marker([d.lat,d.lng],{icon}).addTo(layer);
  m.on("click",()=>edit(d));
 });
}

function edit(d){
 panel.classList.remove("hidden");
 currentRow=d.rowIndex;
 fotoLama=d.foto||"";
 foto.src=d.foto||"https://via.placeholder.com/300x180";
 no_jembatan.value=d.no_jembatan||"";
 nama_jembatan.value=d.nama_jembatan||"";
 ruas_jalan.value=d.ruas_jalan||"";
 desa.value=d.desa_kelurahan||"";
 kecamatan.value=d.kecamatan||"";
 lat.value=d.lat||"";
 lng.value=d.lng||"";
 panjang.value=d.panjang||"";
 lebar.value=d.lebar||"";
 bentang.value=d.jumlah_bentang||"";
 jenis.value=d.jenis_konstruksi||"";
 kondisi.value=d.kondisi||"";
}

function tambahBaru(){
 currentRow=null;fotoLama="";
 panel.classList.remove("hidden");
 document.querySelectorAll("#panel input").forEach(i=>i.value="");
 foto.src="https://via.placeholder.com/300x180";
}

map.on("click",e=>{
 lat.value=e.latlng.lat.toFixed(6);
 lng.value=e.latlng.lng.toFixed(6);
});

function ambilGPS(){
 navigator.geolocation.getCurrentPosition(p=>{
  lat.value=p.coords.latitude.toFixed(6);
  lng.value=p.coords.longitude.toFixed(6);
 });
}

async function simpan(){
 let base64="";
 const f=fotoFile.files[0];
 if(f){
  base64=await new Promise(r=>{
   const fr=new FileReader();
   fr.onload=()=>r(fr.result);
   fr.readAsDataURL(f);
  });
 }
 await fetch(API,{
  method:"POST",
  body:JSON.stringify({
   rowIndex:currentRow,
   no_jembatan:no_jembatan.value,
   nama_jembatan:nama_jembatan.value,
   ruas_jalan:ruas_jalan.value,
   kecamatan:kecamatan.value,
   desa_kelurahan:desa.value,
   lat:lat.value,lng:lng.value,
   panjang:panjang.value,
   lebar:lebar.value,
   jumlah_bentang:bentang.value,
   jenis_konstruksi:jenis.value,
   kondisi:kondisi.value,
   fotoBase64:base64,
   foto_lama:fotoLama
  })
 });
 alert("‚úî Tersimpan");
 panel.classList.add("hidden");
 load();
}
</script>

</body>
</html>
